<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script language="javascript" type="text/javascript" src="../libraries/p5-0.10.2.min.js"></script>
    <script type="module">
      import "./components/CoefficientPicker.js";
      import "./components/CoefficientGrid.js";
      import "./components/ParametricRosetteViewer.js";

      window.addEventListener("load", () => {
        const grid = document.getElementById("coefficient-grid");
        const picker = document.getElementById("coefficient-picker");
        const output = document.getElementById("coefficient");
        const rosette = document.getElementById("rosette");

        grid.addEventListener("coefficient-selected", (e) => {
          picker.coefficient = e.detail;
        });

        grid.addEventListener("coefficients-changed", (e) => {
          const { coefficients } = e.detail;

          const term_strings = [];
          for (let i = 0; i < coefficients.length; i++) {
            const [amp, phase] = coefficients[i];

            // Skip empty terms
            if (amp === 0) {
              continue;
            }

            // There are 11 coefficients, corresponding to frequencies
            // k = [-5, 5]
            const k = i - 5;

            // Force a 5k + 2 symmetry:
            const n = 5 * k + 2;
            const term_string = `${n},${amp},${phase}`;
            term_strings.push(term_string);
          }

          const terms = term_strings.join(":");
          rosette.setAttribute("terms", terms);
        });

        picker.addEventListener("change", (e) => {
          const coefficient = e.detail;

          // Display the selected value on the page
          const amp = coefficient.amplitude.toPrecision(2);
          const phase = coefficient.phase.toPrecision(2);
          const real = coefficient.real.toPrecision(2);
          const imag = coefficient.imag.toPrecision(3);
          output.innerHTML = `Amplitude: ${amp}, phase: ${phase}<br/>(${real} + ${imag} i)`;

          // Update the currently selected coefficient
          grid.update_selected([coefficient.amplitude, coefficient.phase]);
        });
      });
    </script>
    <style>
      .row {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        /*align-items: center;*/
        justify-content: center;
      }

      .ui {
        width: 50%;
      }

      .sketch {
        width: 50%;
      }
    </style>
  </head>
  <body>
    <div class="row">
      <div class="ui">
        <sym-coefficient-grid
          id="coefficient-grid"
          width="550"
          height="50"
          rows="1"
          cols="11"
          coefficients="0,0,0,0,0,0,0,0,0,0,0,0,1,0,0.8,0.2,0.6,0.3,0,0,0,0"
        ></sym-coefficient-grid>
        <sym-coefficient-picker id="coefficient-picker"></sym-coefficient-picker>
        <span id="coefficient"></span>
      </div>
      <div class="sketch">
        <sym-parametric-rosette id="rosette" show-arm="false" preset="3k + 1"></sym-parametric-rosette>
      </div>
    </div>
  </body>
</html>
